<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Specul.ai French Tutor</title>
<meta name="robots" content="noindex" />
<style>
  :root{--bg:#f7f8fb;--card:#fff;--ink:#111;--muted:#6b7280;--primary:#2563eb;--accent:#0ea5e9}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);font-family:system-ui,Segoe UI,Roboto,Apple Color Emoji,Noto Color Emoji,sans-serif;color:var(--ink)}
  .wrap{max-width:820px;margin:32px auto;padding:0 16px}
  .chat{background:var(--card);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.06);overflow:hidden}
  .head{padding:16px 20px;border-bottom:1px solid #eef0f3;font-weight:700}
  .toolbar{display:flex;gap:8px;align-items:center;justify-content:flex-end;padding:10px 20px;border-bottom:1px solid #eef0f3;background:#fafafa}
  .sel{border:1px solid #e5e7eb;border-radius:10px;padding:8px 10px;background:#fff}
  .iconbtn{border:1px solid #e5e7eb;border-radius:10px;padding:8px 12px;background:#fff;cursor:pointer}
  .msgs{padding:20px;display:flex;flex-direction:column;gap:14px;max-height:64vh;overflow:auto}
  .row{display:flex;gap:10px;align-items:flex-start}
  .row.you{justify-content:flex-start}.row.me{justify-content:flex-end}
  .bubble{max-width:78%;padding:14px;border-radius:14px;line-height:1.5}
  .you .bubble{background:#eef2ff;color:#1f2937;border-top-left-radius:6px}
  .me  .bubble{background:#e0ecff;color:#0b3b8d;border-top-right-radius:6px}
  .avatar{width:28px;height:28px;border-radius:50%;background:#e5e7eb;flex:0 0 28px;display:flex;align-items:center;justify-content:center;font-size:12px}
  .foot{display:flex;gap:10px;padding:14px;border-top:1px solid #eef0f3;background:#fafafa}
  .in{flex:1;padding:12px 14px;border:1px solid #e5e7eb;border-radius:12px}
  .btn{padding:12px 16px;background:var(--primary);color:#fff;border:0;border-radius:12px;font-weight:600;cursor:pointer}
  footer{margin-top:16px;font-size:12px;color:var(--muted);text-align:center}

  /* tutor response formatting */
  .section{margin:6px 0 10px;font-weight:700}
  .frline{display:flex;align-items:center;gap:10px;margin:6px 0 6px}
  .fr{font-weight:600}
  .ko{color:#374151}
  .speak{border:1px solid var(--accent);color:#0369a1;background:#e0f2fe;border-radius:10px;padding:6px 10px;cursor:pointer;font-weight:600}
  .road{border-top:1px dashed #e5e7eb;margin-top:10px;padding-top:8px;color:#475569;font-size:14px}
  .kbd{display:inline-block;border:1px solid #e5e7eb;border-bottom-width:2px;border-radius:6px;padding:2px 6px;font-family:ui-monospace, SFMono-Regular, Menlo, monospace;background:#f8fafc}
</style>
</head>
<body>
<div class="wrap">
  <div class="chat">
    <div class="head">Specul.ai Tutor â€” French AI</div>

    <div class="toolbar">
      <label for="lang">ì…ë ¥ ì–¸ì–´</label>
      <select id="lang" class="sel">
        <option value="ko-KR" selected>í•œêµ­ì–´</option>
        <option value="en-US">English</option>
        <option value="fr-FR">FranÃ§ais</option>
      </select>
      <button id="micBtn" type="button" class="iconbtn" title="ìŒì„± ì…ë ¥ ì‹œì‘/ì¤‘ì§€">ğŸ¤ Mic</button>
    </div>

    <div id="msgs" class="msgs"></div>

    <form class="foot" onsubmit="sendMessage(event)">
      <input id="input" class="in" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ë§ˆì´í¬ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”â€¦" autocomplete="off">
      <button class="btn" type="submit">Send</button>
    </form>
  </div>
  <footer>Demo UI only. No real learner data collected.</footer>
</div>

<script>
const API_BASE = "https://speculai-demo.vercel.app"; // Vercel API

function el(t,c,h){const e=document.createElement(t);if(c)e.className=c;if(h)e.innerHTML=h;return e;}
function appendMessage(role, nodeOrText){
  const row = el('div','row '+(role==='me'?'me':'you'));
  if(role==='you') row.appendChild(el('div','avatar','AI'));
  const b = el('div','bubble');
  if (typeof nodeOrText === 'string') b.textContent = nodeOrText; else b.appendChild(nodeOrText);
  row.appendChild(b); const m=document.getElementById('msgs'); m.appendChild(row); m.scrollTop=m.scrollHeight;
}
function appendTyping(){window._typing=el('div','row you');_typing.appendChild(el('div','avatar','AI'));_typing.appendChild(el('div','bubble','â€¦typing'));document.getElementById('msgs').appendChild(_typing);}
function removeTyping(){ if(window._typing){ _typing.remove(); window._typing=null; } }

// ---- ë§ˆì´í¬(STT) : HTTPS í•„ìš” ----
let recognition, recognizing=false;
function initSTT(lang){const SR=window.SpeechRecognition||window.webkitSpeechRecognition;if(!SR)return null;const r=new SR();r.lang=lang;r.interimResults=false;r.maxAlternatives=1;r.onresult=e=>{document.getElementById('input').value=e.results[0][0].transcript;};r.onend=()=>{recognizing=false;updateMicBtn();};return r;}
function toggleMic(){const lang=document.getElementById('lang').value;if(!recognition)recognition=initSTT(lang);if(!recognition)return;if(recognizing){recognition.stop();recognizing=false;}else{recognition.lang=lang;recognition.start();recognizing=true;}updateMicBtn();}
function updateMicBtn(){document.getElementById('micBtn').textContent=recognizing?'ğŸ›‘ Stop':'ğŸ¤ Mic';}
document.getElementById('micBtn').onclick=toggleMic;

// ---- ElevenLabs TTS: í”„ë‘ìŠ¤ì–´ ë¬¸ì¥ë§Œ í´ë¦­í•´ì„œ ì¬ìƒ ----
async function speakFR(text){
  try{
    const r = await fetch(`${API_BASE}/api/tts`, {
      method: "POST", headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ text, lang: "fr-FR" })
    });
    const { audio } = await r.json();
    if (!audio) return;
    const a = new Audio(`data:audio/mpeg;base64,${audio}`);
    await a.play().catch(()=>{});
  }catch(e){ console.warn("TTS error", e); }
}

// ---- íŠœí„° ì‘ë‹µ í¬ë§¤íŒ… ë Œë”ëŸ¬ ----
// ê¸°ëŒ€ í¬ë§·(ë°±ì—”ë“œ í”„ë¡¬í”„íŠ¸ë¡œ ê°•ì œ):
// 1) í•œê¸€ ì•ˆë‚´ 1-2ë¬¸ì¥
// 2) "í‘œí˜„" ì„¹ì…˜ (ì¤„ë§ˆë‹¤ "FR: ..., KO: ..." í˜•íƒœ, ìµœëŒ€ 3~5ê°œ)
// 3) "ì—°ìŠµ" í•œ ì¤„
// 4) "ë‹¤ìŒ ìˆ˜ì—…" í•œ ì¤„
function renderTutor(text){
  const root = el('div');
  const lines = text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);

  // ì„¹ì…˜ì„ ë‹¨ìˆœ íƒì§€
  let mode = 'desc';
  const desc = [];
  const expr = [];
  const practice = [];
  const roadmap = [];

  for (const line of lines){
    const lower = line.toLowerCase();
    if (lower.startsWith('í‘œí˜„') || lower.startsWith('expressions') || lower.startsWith('phrases')) { mode='expr'; continue; }
    if (lower.startsWith('ì—°ìŠµ') || lower.startsWith('practice')) { mode='prac'; continue; }
    if (lower.startsWith('ë‹¤ìŒ ìˆ˜ì—…') || lower.startsWith('next lesson')) { mode='road'; continue; }
    if (mode==='desc') desc.push(line);
    else if (mode==='expr') expr.push(line);
    else if (mode==='prac') practice.push(line);
    else if (mode==='road') roadmap.push(line);
  }

  // 1) ì„¤ëª…
  if (desc.length){
    const p = el('div'); p.style.margin="4px 0 10px"; p.textContent = desc.join(' ');
    root.appendChild(p);
  }

  // 2) í‘œí˜„ ëª©ë¡ (FR/KO ë¶„ë¦¬ + [ë“£ê¸°] ë²„íŠ¼)
  if (expr.length){
    root.appendChild(el('div','section','í‘œí˜„'));
    expr.forEach(line=>{
      // ê¸°ëŒ€: "FR: Bonjour. KO: ì•ˆë…•í•˜ì„¸ìš”."
      const m = line.match(/FR:\s*(.+?)(?:\s*KO:|$)/i);
      const mko= line.match(/KO:\s*(.+)$/i);
      const fr = m ? m[1].trim() : line;
      const ko = mko? mko[1].trim(): '';
      const row = el('div','frline');
      const frSpan = el('span','fr',fr);
      const btn = el('button','speak','ë“£ê¸°'); // "ë°œìŒ ë“£ê¸°", "ì›ì–´ë¯¼ ë“£ê¸°" ë“±ìœ¼ë¡œ ë°”ê¾¸ì…”ë„ ë©ë‹ˆë‹¤.
      btn.type='button'; btn.onclick=()=>speakFR(fr);
      const koSpan = el('span','ko', ko ? 'â€” ' + ko : '');
      row.appendChild(frSpan); row.appendChild(btn); row.appendChild(koSpan);
      root.appendChild(row);
    });
  }

  // 3) ì—°ìŠµ
  if (practice.length){
    root.appendChild(el('div','section','ì—°ìŠµ'));
    const p = el('div'); p.textContent = practice.join(' ');
    root.appendChild(p);
  }

  // 4) ë¡œë“œë§µ
  if (roadmap.length){
    const r = el('div','road', 'ë‹¤ìŒ ìˆ˜ì—…: ' + roadmap.join(' '));
    root.appendChild(r);
  }

  return root;
}

// ---- GPT í˜¸ì¶œ ----
async function sendMessage(ev){
  ev.preventDefault();
  const i=document.getElementById('input');
  const text=i.value.trim();
  if(!text) return;
  appendMessage('me', text);
  i.value=''; appendTyping();

  try{
    const r = await fetch(`${API_BASE}/api/chat`, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ message: text })
    });
    const data = await r.json();
    removeTyping();
    const reply = data.reply || '(ì‘ë‹µì´ ì—†ìŠµë‹ˆë‹¤)';
    appendMessage('you', renderTutor(reply)); // í¬ë§¤íŒ… ì ìš©
  }catch(e){
    console.error(e);
    removeTyping();
    appendMessage('you','(Network error)');
  }
}

// ---- ì´ˆê¸° ì›°ì»´(ìŒì„± ì—†ìŒ) ----
window.addEventListener('load', ()=>{
  const welcome = "ì•ˆë…•í•˜ì„¸ìš”, Specul.ai í”„ë‘ìŠ¤ì–´ íŠœí„°ì…ë‹ˆë‹¤. ğŸ˜Š ì˜¤ëŠ˜ì€ ì–´ë–¤ ì£¼ì œë‚˜ í‘œí˜„ì„ ë°°ìš°ê³  ì‹¶ìœ¼ì„¸ìš”? (ì—¬í–‰, ë¬¸í™”, ë¬¸ë²•, ë‹¨ì–´ ë“± ììœ ë¡­ê²Œ ë§ì”€í•´ ì£¼ì„¸ìš”)";
  appendMessage('you', welcome);
});
</script>
</body>
</html>