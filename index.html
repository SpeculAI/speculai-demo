<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Specul.ai Tutor Demo</title>
<meta name="robots" content="noindex" />
<style>
  :root{--bg:#f7f8fb;--card:#fff;--ink:#111;--muted:#6b7280;--primary:#2563eb}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);font-family:system-ui,Segoe UI,Roboto,Apple Color Emoji,Noto Color Emoji,sans-serif;color:var(--ink)}
  .wrap{max-width:780px;margin:32px auto;padding:0 16px}
  .chat{background:var(--card);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.06);overflow:hidden}
  .head{padding:16px 20px;border-bottom:1px solid #eef0f3;font-weight:600}
  .toolbar{display:flex;gap:8px;align-items:center;justify-content:flex-end;padding:10px 20px;border-bottom:1px solid #eef0f3;background:#fafafa}
  .sel{border:1px solid #e5e7eb;border-radius:10px;padding:8px 10px;background:#fff}
  .iconbtn{border:1px solid #e5e7eb;border-radius:10px;padding:8px 12px;background:#fff;cursor:pointer}
  .msgs{padding:20px;display:flex;flex-direction:column;gap:12px;max-height:60vh;overflow:auto}
  .row{display:flex;gap:10px;align-items:flex-start}
  .row.you{justify-content:flex-start}.row.me{justify-content:flex-end}
  .bubble{max-width:74%;padding:12px 14px;border-radius:14px;line-height:1.35;word-wrap:break-word}
  .you .bubble{background:#eef2ff;color:#1f2937;border-top-left-radius:6px}
  .me .bubble{background:#e0ecff;color:#0b3b8d;border-top-right-radius:6px}
  .avatar{width:28px;height:28px;border-radius:50%;background:#e5e7eb;flex:0 0 28px;display:flex;align-items:center;justify-content:center;font-size:12px;color:#555}
  .foot{display:flex;gap:10px;padding:14px;border-top:1px solid #eef0f3;background:#fafafa}
  .in{flex:1;padding:12px 14px;border:1px solid #e5e7eb;border-radius:12px;outline:none}
  .btn{padding:12px 16px;background:var(--primary);color:#fff;border:0;border-radius:12px;font-weight:600;cursor:pointer}
  footer{margin-top:16px;font-size:12px;color:var(--muted);text-align:center}
</style>
</head>
<body>
<div class="wrap">
  <div class="chat" role="application" aria-label="Specul.ai Tutor demo">
    <div class="head">Specul.ai Tutor — 한국어/영어 지원</div>

    <!-- 언어 선택(음성 인식용) + 음성 선택(TTS) + 마이크 버튼 -->
    <div class="toolbar">
      <label for="lang" style="font-size:14px;color:#374151">입력 언어</label>
      <select id="lang" class="sel" aria-label="Input language">
        <option value="ko-KR" selected>한국어 (ko-KR)</option>
        <option value="en-US">English (en-US)</option>
      </select>

      <label for="voice" style="font-size:14px;color:#374151">음성</label>
      <select id="voice" class="sel" aria-label="TTS voice list"></select>

      <button id="micBtn" type="button" class="iconbtn" title="음성 입력 시작/중지">🎤 Mic</button>
    </div>

    <div id="msgs" class="msgs"></div>

    <form class="foot" onsubmit="sendMessage(event)">
      <input id="input" class="in" placeholder="메시지를 입력하거나 마이크 버튼을 누르세요…" autocomplete="off">
      <button class="btn" type="submit">Send</button>
    </form>
  </div>
  <footer>Demo UI only. No real learner data collected.</footer>
</div>

<script>
const API_BASE = "https://speculai-demo.vercel.app"; // ← Vercel API 도메인

// ---------- UI 유틸 ----------
function el(t,c,h){const e=document.createElement(t);if(c)e.className=c;if(h)e.innerHTML=h;return e;}
function appendMessage(role,text){
  const row=el('div','row '+(role==='me'?'me':'you'));
  if(role==='you'){ row.appendChild(el('div','avatar','AI')); }
  const b=el('div','bubble'); b.textContent=text; row.appendChild(b);
  const m=document.getElementById('msgs'); m.appendChild(row); m.scrollTop=m.scrollHeight;
}
function appendTyping(){
  window._typing=el('div','row you');
  _typing.appendChild(el('div','avatar','AI'));
  _typing.appendChild(el('div','bubble','…typing'));
  const m=document.getElementById('msgs'); m.appendChild(_typing); m.scrollTop=m.scrollHeight;
}
function removeTyping(){ if(window._typing){ _typing.remove(); window._typing=null; } }

// ---------- 음성 목록 로딩(고품질/프랑스어 우선 정렬) ----------
let voices = [];
function loadVoices() {
  voices = window.speechSynthesis.getVoices();
  const sel = document.getElementById('voice');
  sel.innerHTML = '';
  // 선호도 점수: 프랑스어 + 구글/프리미엄 이름 우선
  const score = v => ((/fr/i.test(v.lang)?100:0) + (/google|premium|enhanced/i.test(v.name)?10:0));
  const sorted = [...voices].sort((a,b)=>score(b)-score(a));
  sorted.forEach(v=>{
    const opt = document.createElement('option');
    opt.value = v.name;
    opt.textContent = `${v.name} (${v.lang})`;
    sel.appendChild(opt);
  });
  if (sorted.length) sel.value = sorted[0].name;
}
window.speechSynthesis.onvoiceschanged = loadVoices;
if (window.speechSynthesis.getVoices().length) loadVoices();

// ---------- TTS (마크다운/기호 제거 후 읽기) ----------
function cleanForTTS(text){
  return text
    .replace(/\*\*/g,'')                     // **bold**
    .replace(/`{1,3}[^`]*`{1,3}/g,'')        // `code`
    .replace(/\[([^\]]+)\]\([^)]+\)/g,'$1')  // [link](url) -> link
    .replace(/[*_~>#-]{1,}/g,' ')            // 잔여 마크
    .replace(/\s{2,}/g,' ')
    .trim();
}
function detectLangFromText(text){
  if (/[ㄱ-ㅎ가-힣]/.test(text)) return 'ko-KR';
  if (/^[a-zA-Z0-9\s\p{P}]+$/u.test(text)) return 'en-US';
  return 'fr-FR';
}
function speak(text) {
  if (!('speechSynthesis' in window)) return;
  const t = cleanForTTS(text);
  const chosen = voices.find(v=>v.name === (document.getElementById('voice')||{}).value);
  const u = new SpeechSynthesisUtterance(t);
  if (chosen){ u.voice = chosen; u.lang = chosen.lang; }
  else { u.lang = detectLangFromText(t); }
  u.rate=1.0; u.pitch=1.0; u.volume=1.0;
  window.speechSynthesis.cancel(); window.speechSynthesis.speak(u);
}

// ---------- STT (Chrome 권장) ----------
let recognition, recognizing=false;
function initSTT(lang='ko-KR'){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) { alert("이 브라우저는 음성 인식을 지원하지 않습니다 (Chrome 권장)."); return null; }
  const r = new SR();
  r.lang = lang; r.interimResults=false; r.maxAlternatives=1;
  r.onresult = (e)=>{ document.getElementById('input').value = e.results[0][0].transcript; };
  r.onend = ()=>{ recognizing=false; updateMicBtn(); };
  r.onerror = ()=>{ recognizing=false; updateMicBtn(); };
  return r;
}
function toggleMic(){
  const lang = (document.getElementById('lang')||{}).value || 'ko-KR';
  if (!recognition) recognition = initSTT(lang);
  if (!recognition) return;
  if (recognizing){ recognition.stop(); recognizing=false; }
  else { recognition.lang = lang; recognition.start(); recognizing=true; }
  updateMicBtn();
}
function updateMicBtn(){
  const btn = document.getElementById('micBtn');
  if (btn) btn.textContent = recognizing ? '🛑 Stop' : '🎤 Mic';
}
document.getElementById('micBtn').onclick = toggleMic;

// ---------- GPT 호출 ----------
async function sendMessage(ev){
  ev.preventDefault();
  const i=document.getElementById('input');
  const text=i.value.trim();
  if(!text) return;
  appendMessage('me', text);
  i.value=''; i.focus(); appendTyping();

  try {
    const res = await fetch(`${API_BASE}/api/chat`, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ message: text })
    });
    const data = await res.json();
    removeTyping();
    const reply = data.reply || '(응답이 없습니다)';
    appendMessage('you', reply);
    speak(reply);
  } catch(e) {
    console.error(e);
    removeTyping();
    appendMessage('you','(Network error)');
  }
}
</script>
</body>
</html>
